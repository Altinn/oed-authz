using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace oed_authz.Infrastructure.Database.Migrations
{
    /// <inheritdoc />
    public partial class Initial : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            // Baseline setup based on old Yuniql-migrations
            migrationBuilder.Sql("DO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'oedauthz') THEN\r\n            CREATE SCHEMA oedauthz;\r\n        END IF;\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'oedauthz') THEN\r\n            CREATE SCHEMA oedauthz;\r\n        END IF;\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'roleassignments_action') THEN\r\n            CREATE TYPE oedauthz.roleassignments_action AS ENUM ('GRANT', 'REVOKE');\r\n        END IF;\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    CREATE SEQUENCE IF NOT EXISTS oedauthz.roleassignments_id_seq\r\n        INCREMENT 1\r\n        START 1\r\n        MINVALUE 1\r\n        MAXVALUE 9223372036854775807\r\n        CACHE 1;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n    CREATE TABLE IF NOT EXISTS oedauthz.roleassignments (\r\n        id bigint NOT NULL DEFAULT nextval('oedauthz.roleassignments_id_seq'::regclass),\r\n        \"roleCode\" character varying(60) NOT NULL,\r\n        \"estateSsn\" character(11) NOT NULL,\r\n        \"heirSsn\" character(11),\r\n        \"recipientSsn\" character(11) NOT NULL,\r\n        created timestamp with time zone NOT NULL,\r\n        CONSTRAINT roleassignments_pkey PRIMARY KEY (id)\r\n    );\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    CREATE SEQUENCE IF NOT EXISTS oedauthz.roleassignments_log_id_seq\r\n        INCREMENT 1\r\n        START 1\r\n        MINVALUE 1\r\n        MAXVALUE 9223372036854775807\r\n        CACHE 1;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n    CREATE TABLE IF NOT EXISTS oedauthz.roleassignments_log (\r\n        id bigint NOT NULL DEFAULT nextval('oedauthz.roleassignments_log_id_seq'::regclass),\r\n        \"roleCode\" character varying(60) NOT NULL,\r\n        \"estateSsn\" character(11) NOT NULL,\r\n        \"heirSsn\" character(11),\r\n        \"recipientSsn\" character(11) NOT NULL,\r\n        action oedauthz.roleassignments_action NOT NULL,\r\n        timestamp timestamp with time zone NOT NULL,\r\n        CONSTRAINT roleassignments_log_pkey PRIMARY KEY (id)\r\n    );\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        IF NOT EXISTS (SELECT 1 FROM information_schema.table_constraints WHERE table_schema = 'oedauthz' AND table_name = 'roleassignments' AND constraint_name = 'constraint_roleassignment') THEN\r\n            CREATE UNIQUE INDEX constraint_roleassignment ON oedauthz.roleassignments (\"estateSsn\", \"recipientSsn\", \"roleCode\", \"heirSsn\");\r\n        END IF;\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        CREATE INDEX IF NOT EXISTS idx_created ON oedauthz.roleassignments (created);\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        CREATE INDEX IF NOT EXISTS idx_estatessn ON oedauthz.roleassignments (\"estateSsn\");\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        CREATE INDEX IF NOT EXISTS\"idx_recipientSsn\" ON oedauthz.roleassignments (\"recipientSsn\");\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        CREATE INDEX IF NOT EXISTS \"idx_roleCode\" ON oedauthz.roleassignments (\"roleCode\");\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        CREATE UNIQUE INDEX IF NOT EXISTS idx_unique_collective_roleassignments ON oedauthz.roleassignments (\"estateSsn\", \"recipientSsn\", \"roleCode\") WHERE (\"heirSsn\" IS NULL);\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        CREATE INDEX IF NOT EXISTS idx_roleassignments_log_estatessn ON oedauthz.roleassignments_log (\"estateSsn\");\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        CREATE INDEX IF NOT EXISTS idx_roleassignments_log_recipientssn ON oedauthz.roleassignments_log (\"recipientSsn\");\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    IF NOT EXISTS(SELECT 1 FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" = '20241112130644_Initial') THEN\r\n        CREATE INDEX IF NOT EXISTS idx_roleassignments_log_timestamp ON oedauthz.roleassignments_log (timestamp);\r\n    END IF;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    ALTER SEQUENCE oedauthz.roleassignments_id_seq\r\n        OWNED BY oedauthz.roleassignments.id;\r\nEND $EF$;\r\n\r\nDO $EF$\r\nBEGIN\r\n    ALTER SEQUENCE oedauthz.roleassignments_log_id_seq\r\n        OWNED BY oedauthz.roleassignments_log.id;\r\nEND $EF$;");
            migrationBuilder.Sql("DO $$\r\n    BEGIN\r\n        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'roleassignments_insert_log') THEN\r\n            DROP TRIGGER roleassignments_insert_log ON oedauthz.roleassignments;\r\n        END IF;\r\n\r\n        IF EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'roleassignments_delete_log') THEN\r\n            DROP TRIGGER roleassignments_delete_log ON oedauthz.roleassignments;\r\n        END IF;\r\n    END $$;\r\n\r\nCREATE OR REPLACE FUNCTION oedauthz.log_roleassignments_changes()\r\n    RETURNS TRIGGER AS $$\r\nBEGIN\r\n    IF TG_OP = 'INSERT' THEN\r\n        INSERT INTO oedauthz.roleassignments_log (\"estateSsn\", \"recipientSsn\", \"roleCode\", \"heirSsn\", \"action\", \"timestamp\")\r\n        VALUES (NEW.\"estateSsn\", NEW.\"recipientSsn\", NEW.\"roleCode\", NEW.\"heirSsn\", 'GRANT', NOW());\r\n        RETURN NEW;\r\n    ELSIF TG_OP = 'DELETE' THEN\r\n        INSERT INTO oedauthz.roleassignments_log (\"estateSsn\", \"recipientSsn\", \"roleCode\", \"heirSsn\", \"action\", \"timestamp\")\r\n        VALUES (OLD.\"estateSsn\", OLD.\"recipientSsn\", OLD.\"roleCode\", OLD.\"heirSsn\", 'REVOKE', NOW());\r\n        RETURN OLD;\r\n    END IF;\r\n    RETURN NULL;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\nCREATE TRIGGER roleassignments_insert_log\r\n    AFTER INSERT ON oedauthz.roleassignments\r\n    FOR EACH ROW\r\nEXECUTE FUNCTION oedauthz.log_roleassignments_changes();\r\n\r\nCREATE TRIGGER roleassignments_delete_log\r\n    AFTER DELETE ON oedauthz.roleassignments\r\n    FOR EACH ROW\r\nEXECUTE FUNCTION oedauthz.log_roleassignments_changes();");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
        }
    }
}
